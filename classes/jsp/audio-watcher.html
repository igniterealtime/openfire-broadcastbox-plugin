<!--
  This example demonstrates how to watch a stream without libraries or dependencies.
  With this HTML you can add a 'Broadcast Box Player' to any site you want
-->

<html>
  <head>
    <title>audio-watcher</title>
    <script src="./js/stophe.min.js"></script>  	
  </head>

  <body>
    <b> Stream Key </b> <input type="text" id="streamKey" /> <br />
    <button onclick="window.watchStream()"> Watch Stream </button>

    <h3> Audio </h3>
    <audio id="audioPlayer" autoplay controls style="width: 500"> </audio>

    <h3> Connection State </h3>
    <div id="connectionState"></div> <br />
  </body>

  <script>
	window.watchStream = () => {
		window.connection = new Strophe.Connection(location.protocol.replace("http", "ws") + "//" + location.host + "/ws/");

		window.connection.connect(location.hostname, null, function (status) {
			console.debug("XMPPConnection.connect", status);

			if (status === Strophe.Status.CONNECTED)  {
				window.connection.send($pres());

				setTimeout(() => {
					const streamKey = document.getElementById('streamKey').value

					if (streamKey === '') {
						return window.alert('Stream Key must not be empty')
					}	
					
					let peerConnection = new RTCPeerConnection()
					peerConnection.addTransceiver('audio', { direction: 'recvonly' })

					peerConnection.ontrack = function (event) {
						document.getElementById('audioPlayer').srcObject = event.streams[0]
					}

					peerConnection.oniceconnectionstatechange = () => {
						document.getElementById('connectionState').innerText = peerConnection.iceConnectionState;
					}

					peerConnection.createOffer().then(offer => {
						peerConnection.setLocalDescription(offer);
						console.debug('whep offer', offer.sdp);					
						
						window.connection.sendIQ($iq({type: 'set', to: window.connection.domain}).c('whep', {id: streamKey, xmlns: 'urn:xmpp:whep:0'}).c('sdp', offer.sdp), 
							function (res)  {
								console.debug('whep response', res);						
								const answer = res.querySelector('sdp').innerHTML;
								peerConnection.setRemoteDescription({sdp: answer,  type: 'answer'});	
								console.debug('whep answer', answer);			

							}, function (err) {
								console.warn('whep failed', err);
							}
						);				
					})
				});
			}
			else

			if (status === Strophe.Status.DISCONNECTED)  {

			}
		});
    }
  </script>
</html>
